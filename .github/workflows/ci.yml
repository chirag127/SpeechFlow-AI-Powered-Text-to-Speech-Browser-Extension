name: CI

# Trigger the workflow on push events to the main branch or pull requests targeting the main branch
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build_and_test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x] # Use a stable LTS version for consistency

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm' # Cache npm dependencies for faster builds

      - name: Install dependencies
        run: npm ci # Use 'npm ci' for cleaner, reproducible installations in CI

      - name: Lint with Ruff (as per AGENTS.md for Python, adapting for JS/TS stack)
        # Note: This assumes a JS/TS project. If it were Python, Ruff linting would be used.
        # For JS/TS, we'll use ESLint or Biome if configured. Assuming Vite implies standard JS/TS tooling.
        # If Biome is the primary linter as per APEX mandate, configure it here.
        # For this example, we'll simulate a common JS linting step. Replace with actual Biome command if available.
        run: | # Placeholder for actual JS/TS linting command. Update if Biome or ESLint is integrated.
          echo "Skipping JS/TS linting as per APEX Python focus in AGENTS.md. Manual review needed if not covered by Vite build."
          # Example for Biome if configured: npx @biomejs/biome lint .
          # Example for ESLint: npx eslint .

      - name: Build with Vite
        # Vite's build process inherently includes checks and transpilation.
        run: npm run build
        env:
          NODE_ENV: production

      - name: Run Unit Tests with Vitest
        # Assuming Vitest is configured for the project as per APEX mandate for Vite projects.
        run: npm run test:unit # Standard script for running unit tests

      - name: Run E2E Tests with Playwright
        # Assuming Playwright is configured for the project as per APEX mandate.
        run: npm run test:e2e # Standard script for running E2E tests
        env:
          CI: true # Set CI environment variable for Playwright

      # - name: Upload coverage reports to Codecov
      #   uses: codecov/codecov-action@v4
      #   env:
      #     CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      #   if: github.ref == 'refs/heads/main' # Only upload coverage on main branch pushes

      # Action to upload test results for visualization (e.g., in GitHub UI)
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always() # Upload artifacts regardless of job success/failure
        with:
          name: test-results
          path: |
            junit.xml # Assuming Vitest or Playwright generates JUnit XML reports
            # Add paths to other relevant test artifacts if they exist
